"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var Subject_1 = require("rxjs/Subject");
var SocketIO = require("nativescript-socket.io");
var singleton_service_1 = require("../singleton-service/singleton.service");
var common_functions_service_1 = require("../common-functions-service/common-functions.service");
var SocketService = /** @class */ (function () {
    function SocketService(ngZone, singleton, cfs) {
        this.ngZone = ngZone;
        this.singleton = singleton;
        this.cfs = cfs;
        this.userBadge = 0;
        this.selectedUsers = {};
        this.listUsers = [];
        this.formTools = new core_1.EventEmitter();
        this.emitChangeSource = new Subject_1.Subject();
        this.changeEmitted$ = this.emitChangeSource.asObservable();
        this.emitChangeUsers = new Subject_1.Subject();
        this.changeUsersEmitted$ = this.emitChangeUsers.asObservable();
        this.intialized = false;
    }
    SocketService.prototype.initSocket = function () {
        var _this = this;
        // marcamos a variável this.intialized para true, para que o socket não seja iniciado mais de uma vez
        this.intialized = true;
        // pedimos conexão do socket para o servidor
        // OBS: passamos o token do usuário para que o token seja validado na hora da conexão ao socket
        this.socket = SocketIO.connect(this.singleton.serverUrl, { query: { 'Authorization': localStorage.getItem('token') } });
        // Evento responsável por ouvir logins de usuários
        this.socket.on('userlogin', function (userLogin) {
            var _this = this;
            console.log("Login de usuário com o id: " + userLogin._id);
            this.ngZone.run(function () {
                // verifico se o id do usuário que efetuou login é igual ao nosso, para que não sejamos notificados do nosso proprio  login em outro dispositivo
                if (userLogin._id != _this.singleton.user["_id"]) {
                    // se for diferente, preciso achar o usuário que efetuou o login e tornar o status dele para true(online)
                    _this.listUsers.map(function (user) {
                        if (user._id == userLogin._id) {
                            if (!user.status) {
                                user.status = true;
                            }
                        }
                    });
                    // ordenamos nossa lista de usuários pelo status
                }
                _this.listUsers = _this.cfs.orderByProperty(_this.listUsers, 'status');
                _this.emitChangeUsers.next();
            });
        }.bind(this));
        // lista dos usuários cadastrados no sistema
        this.socket.on('listUsers', function (listUsers) {
            _this.ngZone.run(function () {
                _this.listUsers = listUsers.all;
                Promise.all(_this.listUsers.map(function (user) {
                    // pegamos o número da badge do usuário e passamos para o objeto user
                    user["badge"] = listUsers["userBadge"][user._id] || 0;
                    _this.singleton.chatBadge += user["badge"];
                    // verificamos se o id do usuário está na lista de usuários online, se estiver, tornamos o status dele para true
                    if (listUsers.available.indexOf(user._id) > -1) {
                        user.status = true;
                    }
                    return;
                }))
                    .then(function () {
                    // ordenamos nossa lista de usuários pelo status
                    _this.listUsers = _this.cfs.orderByProperty(_this.listUsers, 'status');
                    // emitimos um sinal para nosso chatComponent, para dizer que temos uma lista de usuários disponivel para ele
                    _this.emitChangeUsers.next();
                });
            });
        });
        // Evento responsável por ouvir leituras dos usuários a mensagens que você enviou
        this.socket.on('receiverRead', function (userId) {
            console.log("recebeu leitura do usuário: " + userId);
            _this.ngZone.run(function () {
                if (_this.selectedUsers[userId]) {
                    var currentDate = Date.now();
                    _this.selectedUsers[userId].messages.forEach(function (element) {
                        if (element.toUser == userId && !element["toUserRead"]) {
                            element["toUserRead"] = true;
                            element["toUserReadDate"] = currentDate;
                            _this.emitChangeSource.next();
                        }
                    });
                }
            });
        });
        // Evento responsável por ouvir logout de usuários
        this.socket.on('userLogout', function (userId) {
            _this.ngZone.run(function () {
                _this.listUsers.map(function (user) {
                    if (user._id == userId) {
                        user.status = false;
                    }
                });
                _this.listUsers = _this.cfs.orderByProperty(_this.listUsers, 'status');
                _this.emitChangeUsers.next();
            });
        });
        // Evento responsável por ouvir o novas mensagens
        this.socket.on('newMessage', function (message) {
            console.log("new message...");
            _this.ngZone.run(function () {
                if (message._id == _this.singleton.user["_id"] && _this.selectedUsers[message.toUser]) {
                    _this.selectedUsers[message.toUser]["messages"].push(message);
                    if (_this.selectedUsers[message.toUser]["chatOpen"]) {
                        _this.emitChangeSource.next();
                    }
                }
                else {
                    if (!_this.selectedUsers[message._id]) {
                        for (var i = 0; i < _this.listUsers.length; i++) {
                            if (_this.listUsers[i]["_id"] == message._id) {
                                _this.listUsers[i]["badge"]++;
                                _this.singleton.chatBadge++;
                                _this.emitChangeUsers.next();
                                break;
                            }
                        }
                    }
                    else {
                        _this.selectedUsers[message._id]["messages"].push(message);
                        if (_this.selectedUsers[message._id]["chatOpen"]) {
                            _this.emmitFocus({ room_id: _this.selectedUsers[message._id]["room_id"], updateAll: false, senderId: message._id });
                            message["toUserRead"] = true;
                            _this.emitChangeSource.next();
                        }
                        else {
                            _this.singleton.chatBadge++;
                            console.log("incrementing the badge...");
                            _this.selectedUsers[message._id]["badge"] = _this.selectedUsers[message._id]["badge"] + 1;
                            console.log("the badge now is: " + _this.selectedUsers[message._id]["badge"]);
                            _this.emitChangeUsers.next();
                        }
                    }
                }
            });
        });
    };
    // evento responsável por emitir o focus, ou seja, confirmar leitura de das mensagens
    SocketService.prototype.emmitFocus = function (obj) {
        var _this = this;
        this.ngZone.run(function () {
            if (_this.selectedUsers[obj["senderId"]]["messages"]) {
                _this.socket.emit('focus', obj["room_id"]);
                if (obj["updateAll"]) {
                    _this.selectedUsers[obj["senderId"]]["messages"].forEach(function (element) {
                        if (element._id == obj["senderId"]) {
                            element["toUserRead"] = true;
                        }
                    });
                }
                _this.singleton.chatBadge = _this.singleton.chatBadge - _this.selectedUsers[obj["senderId"]]["badge"];
                _this.selectedUsers[obj["senderId"]]["badge"] = 0;
            }
        });
    };
    // Evento responsável emitir para o servidor a seleção de um usuário
    SocketService.prototype.emmitSelect = function (_id) {
        var _this = this;
        console.log("user id:" + _id);
        return new Promise(function (resolve) {
            _this.socket.emit('selectUser', { _id: _this.singleton.user["_id"], toUser: _id }, function (room) {
                _this.ngZone.run(function () {
                    _this.selectedUsers[_id]["messages"] = room["messages"] || [];
                    _this.selectedUsers[_id]["room_id"] = room["_id"];
                    _this.emmitFocus({ room_id: room["_id"], senderId: _id, updateAll: true });
                    return resolve();
                });
            });
        });
    };
    // Evento responsável por se desconectar do servidor
    SocketService.prototype.disconect = function () {
        this.intialized = false;
        this.socket.disconect();
    };
    // Evento responsável por emitir uma mensagem para o servidor
    SocketService.prototype.sendMessage = function (arr) {
        this.socket.emit('sendMessage', { room_id: arr[2], name: this.singleton.user["name"], _id: this.singleton.user["_id"], message: arr[0], toUser: arr[1], date: Date.now(), toUserRead: false });
    };
    SocketService = __decorate([
        core_1.Injectable(),
        __metadata("design:paramtypes", [core_1.NgZone, singleton_service_1.SingletonService, common_functions_service_1.CommonFunctionsService])
    ], SocketService);
    return SocketService;
}());
exports.SocketService = SocketService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ja2V0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzb2NrZXQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLHNDQUFpRTtBQUNqRSx3Q0FBdUM7QUFDdkMsaURBQW1EO0FBQ25ELDRFQUEwRTtBQUMxRSxpR0FBOEY7QUFFOUY7SUFZSSx1QkFBb0IsTUFBYSxFQUFTLFNBQTBCLEVBQVMsR0FBMkI7UUFBcEYsV0FBTSxHQUFOLE1BQU0sQ0FBTztRQUFTLGNBQVMsR0FBVCxTQUFTLENBQWlCO1FBQVMsUUFBRyxHQUFILEdBQUcsQ0FBd0I7UUFWeEcsY0FBUyxHQUFHLENBQUMsQ0FBQztRQUNkLGtCQUFhLEdBQUcsRUFBRSxDQUFDO1FBQ25CLGNBQVMsR0FBRyxFQUFFLENBQUM7UUFDZixjQUFTLEdBQXNCLElBQUksbUJBQVksRUFBRSxDQUFDO1FBQzFDLHFCQUFnQixHQUFHLElBQUksaUJBQU8sRUFBTyxDQUFDO1FBQzlDLG1CQUFjLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFlBQVksRUFBRSxDQUFDO1FBQzlDLG9CQUFlLEdBQUcsSUFBSSxpQkFBTyxFQUFPLENBQUM7UUFDN0Msd0JBQW1CLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUMxRCxlQUFVLEdBQUcsS0FBSyxDQUFDO0lBRXdGLENBQUM7SUFDckcsa0NBQVUsR0FBakI7UUFBQSxpQkE4SUM7UUE3SUcscUdBQXFHO1FBQ3JHLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBRXZCLDRDQUE0QztRQUM1QywrRkFBK0Y7UUFDL0YsSUFBSSxDQUFDLE1BQU0sR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLEVBQUMsS0FBSyxFQUFFLEVBQUMsZUFBZSxFQUFFLFlBQVksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBQyxDQUFDLENBQUM7UUFF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O1FBQ3hCLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVELDZEQUE2RDtJQUM3RCxtQ0FBVyxHQUFYLFVBQVksR0FBRztRQUViLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRyxFQUFFLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQztJQUNqTSxDQUFDO0lBNU1RLGFBQWE7UUFEekIsaUJBQVUsRUFBRTt5Q0Fha0IsYUFBTSxFQUFtQixvQ0FBZ0IsRUFBYyxpREFBc0I7T0FaL0YsYUFBYSxDQTZNekI7SUFBRCxvQkFBQztDQUFBLEFBN01ELElBNk1DO0FBN01ZLHNDQUFhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMvT2JzZXJ2YWJsZSc7XG5pbXBvcnQgeyBJbmplY3RhYmxlLCBFdmVudEVtaXR0ZXIsIE5nWm9uZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMvU3ViamVjdCc7XG5pbXBvcnQgKiBhcyBTb2NrZXRJTyBmcm9tIFwibmF0aXZlc2NyaXB0LXNvY2tldC5pb1wiO1xuaW1wb3J0IHsgU2luZ2xldG9uU2VydmljZSB9IGZyb20gJy4uL3NpbmdsZXRvbi1zZXJ2aWNlL3NpbmdsZXRvbi5zZXJ2aWNlJztcbmltcG9ydCB7IENvbW1vbkZ1bmN0aW9uc1NlcnZpY2UgfSBmcm9tICcuLi9jb21tb24tZnVuY3Rpb25zLXNlcnZpY2UvY29tbW9uLWZ1bmN0aW9ucy5zZXJ2aWNlJztcbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTb2NrZXRTZXJ2aWNlIHtcbiAgICBzb2NrZXQ6IGFueTtcbiAgICB1c2VyQmFkZ2UgPSAwO1xuICAgIHNlbGVjdGVkVXNlcnMgPSB7fTtcbiAgICBsaXN0VXNlcnMgPSBbXTtcbiAgICBmb3JtVG9vbHM6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgIHByaXZhdGUgZW1pdENoYW5nZVNvdXJjZSA9IG5ldyBTdWJqZWN0PGFueT4oKTtcbiAgICBjaGFuZ2VFbWl0dGVkJCA9IHRoaXMuZW1pdENoYW5nZVNvdXJjZS5hc09ic2VydmFibGUoKTtcbiAgICBwcml2YXRlIGVtaXRDaGFuZ2VVc2VycyA9IG5ldyBTdWJqZWN0PGFueT4oKTtcbiAgICBjaGFuZ2VVc2Vyc0VtaXR0ZWQkID0gdGhpcy5lbWl0Q2hhbmdlVXNlcnMuYXNPYnNlcnZhYmxlKCk7XG4gICAgaW50aWFsaXplZCA9IGZhbHNlO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBuZ1pvbmU6Tmdab25lLCBwdWJsaWMgc2luZ2xldG9uOlNpbmdsZXRvblNlcnZpY2UsIHB1YmxpYyBjZnM6IENvbW1vbkZ1bmN0aW9uc1NlcnZpY2UpIHt9XG4gICAgcHVibGljIGluaXRTb2NrZXQoKXtcbiAgICAgICAgLy8gbWFyY2Ftb3MgYSB2YXJpw6F2ZWwgdGhpcy5pbnRpYWxpemVkIHBhcmEgdHJ1ZSwgcGFyYSBxdWUgbyBzb2NrZXQgbsOjbyBzZWphIGluaWNpYWRvIG1haXMgZGUgdW1hIHZlelxuICAgICAgICB0aGlzLmludGlhbGl6ZWQgPSB0cnVlO1xuXG4gICAgICAgIC8vIHBlZGltb3MgY29uZXjDo28gZG8gc29ja2V0IHBhcmEgbyBzZXJ2aWRvclxuICAgICAgICAvLyBPQlM6IHBhc3NhbW9zIG8gdG9rZW4gZG8gdXN1w6FyaW8gcGFyYSBxdWUgbyB0b2tlbiBzZWphIHZhbGlkYWRvIG5hIGhvcmEgZGEgY29uZXjDo28gYW8gc29ja2V0XG4gICAgICAgIHRoaXMuc29ja2V0ID0gU29ja2V0SU8uY29ubmVjdCh0aGlzLnNpbmdsZXRvbi5zZXJ2ZXJVcmwsIHtxdWVyeTogeydBdXRob3JpemF0aW9uJzogbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3Rva2VuJykgfX0pO1xuICAgICAgICBcbiAgICAgICAgLy8gRXZlbnRvIHJlc3BvbnPDoXZlbCBwb3Igb3V2aXIgbG9naW5zIGRlIHVzdcOhcmlvc1xuICAgICAgICB0aGlzLnNvY2tldC5vbigndXNlcmxvZ2luJywgZnVuY3Rpb24gKHVzZXJMb2dpbikge1xuXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkxvZ2luIGRlIHVzdcOhcmlvIGNvbSBvIGlkOiBcIit1c2VyTG9naW4uX2lkKTtcbiAgICAgICAgICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB7XG4gICAgICAgICAgICAvLyB2ZXJpZmljbyBzZSBvIGlkIGRvIHVzdcOhcmlvIHF1ZSBlZmV0dW91IGxvZ2luIMOpIGlndWFsIGFvIG5vc3NvLCBwYXJhIHF1ZSBuw6NvIHNlamFtb3Mgbm90aWZpY2Fkb3MgZG8gbm9zc28gcHJvcHJpbyAgbG9naW4gZW0gb3V0cm8gZGlzcG9zaXRpdm9cbiAgICAgICAgICAgICAgICBpZih1c2VyTG9naW4uX2lkICE9IHRoaXMuc2luZ2xldG9uLnVzZXJbXCJfaWRcIl0pXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAvLyBzZSBmb3IgZGlmZXJlbnRlLCBwcmVjaXNvIGFjaGFyIG8gdXN1w6FyaW8gcXVlIGVmZXR1b3UgbyBsb2dpbiBlIHRvcm5hciBvIHN0YXR1cyBkZWxlIHBhcmEgdHJ1ZShvbmxpbmUpXG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxpc3RVc2Vycy5tYXAodXNlcj0+e1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYodXNlci5faWQgPT0gdXNlckxvZ2luLl9pZClcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighdXNlci5zdGF0dXMpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VyLnN0YXR1cyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC8vIG9yZGVuYW1vcyBub3NzYSBsaXN0YSBkZSB1c3XDoXJpb3MgcGVsbyBzdGF0dXNcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5saXN0VXNlcnMgPSB0aGlzLmNmcy5vcmRlckJ5UHJvcGVydHkodGhpcy5saXN0VXNlcnMsICdzdGF0dXMnKTtcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXRDaGFuZ2VVc2Vycy5uZXh0KCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfS5iaW5kKHRoaXMpKTtcblxuICAgICAgICAvLyBsaXN0YSBkb3MgdXN1w6FyaW9zIGNhZGFzdHJhZG9zIG5vIHNpc3RlbWFcbiAgICAgICAgdGhpcy5zb2NrZXQub24oJ2xpc3RVc2VycycsIChsaXN0VXNlcnMpPT57XG4gICAgICAgICAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubGlzdFVzZXJzID0gbGlzdFVzZXJzLmFsbDtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBQcm9taXNlLmFsbCh0aGlzLmxpc3RVc2Vycy5tYXAodXNlcj0+e1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIHBlZ2Ftb3MgbyBuw7ptZXJvIGRhIGJhZGdlIGRvIHVzdcOhcmlvIGUgcGFzc2Ftb3MgcGFyYSBvIG9iamV0byB1c2VyXG4gICAgICAgICAgICAgICAgICAgIHVzZXJbXCJiYWRnZVwiXSA9IGxpc3RVc2Vyc1tcInVzZXJCYWRnZVwiXVt1c2VyLl9pZF0gfHwgMDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaW5nbGV0b24uY2hhdEJhZGdlICs9IHVzZXJbXCJiYWRnZVwiXTtcblxuICAgICAgICAgICAgICAgICAgICAvLyB2ZXJpZmljYW1vcyBzZSBvIGlkIGRvIHVzdcOhcmlvIGVzdMOhIG5hIGxpc3RhIGRlIHVzdcOhcmlvcyBvbmxpbmUsIHNlIGVzdGl2ZXIsIHRvcm5hbW9zIG8gc3RhdHVzIGRlbGUgcGFyYSB0cnVlXG4gICAgICAgICAgICAgICAgICAgIGlmKGxpc3RVc2Vycy5hdmFpbGFibGUuaW5kZXhPZih1c2VyLl9pZCkgPiAtMSlcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgdXNlci5zdGF0dXMgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9KSlcbiAgICAgICAgICAgICAgICAudGhlbigoKT0+e1xuICAgICAgICAgICAgICAgICAgICAvLyBvcmRlbmFtb3Mgbm9zc2EgbGlzdGEgZGUgdXN1w6FyaW9zIHBlbG8gc3RhdHVzXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdFVzZXJzID0gdGhpcy5jZnMub3JkZXJCeVByb3BlcnR5KHRoaXMubGlzdFVzZXJzLCAnc3RhdHVzJylcbiAgICAgICAgICAgICAgICAgICAgIC8vIGVtaXRpbW9zIHVtIHNpbmFsIHBhcmEgbm9zc28gY2hhdENvbXBvbmVudCwgcGFyYSBkaXplciBxdWUgdGVtb3MgdW1hIGxpc3RhIGRlIHVzdcOhcmlvcyBkaXNwb25pdmVsIHBhcmEgZWxlXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdENoYW5nZVVzZXJzLm5leHQoKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pXG5cbiAgICAgICAgLy8gRXZlbnRvIHJlc3BvbnPDoXZlbCBwb3Igb3V2aXIgbGVpdHVyYXMgZG9zIHVzdcOhcmlvcyBhIG1lbnNhZ2VucyBxdWUgdm9jw6ogZW52aW91XG4gICAgICAgIHRoaXMuc29ja2V0Lm9uKCdyZWNlaXZlclJlYWQnLCAodXNlcklkKT0+e1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJyZWNlYmV1IGxlaXR1cmEgZG8gdXN1w6FyaW86IFwiK3VzZXJJZCk7XG4gICAgICAgICAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmKHRoaXMuc2VsZWN0ZWRVc2Vyc1t1c2VySWRdKVxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnREYXRlID0gRGF0ZS5ub3coKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZFVzZXJzW3VzZXJJZF0ubWVzc2FnZXMuZm9yRWFjaChlbGVtZW50ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGVsZW1lbnQudG9Vc2VyID09IHVzZXJJZCAmJiAhZWxlbWVudFtcInRvVXNlclJlYWRcIl0pXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudFtcInRvVXNlclJlYWRcIl0gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbXCJ0b1VzZXJSZWFkRGF0ZVwiXSA9IGN1cnJlbnREYXRlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdENoYW5nZVNvdXJjZS5uZXh0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG5cbiAgICAgICAgLy8gRXZlbnRvIHJlc3BvbnPDoXZlbCBwb3Igb3V2aXIgbG9nb3V0IGRlIHVzdcOhcmlvc1xuICAgICAgICB0aGlzLnNvY2tldC5vbigndXNlckxvZ291dCcsICh1c2VySWQpPT57XG4gICAgICAgICAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5saXN0VXNlcnMubWFwKHVzZXI9PntcbiAgICAgICAgICAgICAgICBpZih1c2VyLl9pZCA9PSB1c2VySWQpXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICB1c2VyLnN0YXR1cyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIHRoaXMubGlzdFVzZXJzID0gdGhpcy5jZnMub3JkZXJCeVByb3BlcnR5KHRoaXMubGlzdFVzZXJzLCAnc3RhdHVzJyk7XG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0Q2hhbmdlVXNlcnMubmV4dCgpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcblxuICAgICAgICAvLyBFdmVudG8gcmVzcG9uc8OhdmVsIHBvciBvdXZpciBvIG5vdmFzIG1lbnNhZ2Vuc1xuICAgICAgICB0aGlzLnNvY2tldC5vbignbmV3TWVzc2FnZScsIChtZXNzYWdlKT0+e1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJuZXcgbWVzc2FnZS4uLlwiKTtcbiAgICAgICAgICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYobWVzc2FnZS5faWQgPT0gdGhpcy5zaW5nbGV0b24udXNlcltcIl9pZFwiXSAmJiB0aGlzLnNlbGVjdGVkVXNlcnNbbWVzc2FnZS50b1VzZXJdKVxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZFVzZXJzW21lc3NhZ2UudG9Vc2VyXVtcIm1lc3NhZ2VzXCJdLnB1c2gobWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc2VsZWN0ZWRVc2Vyc1ttZXNzYWdlLnRvVXNlcl1bXCJjaGF0T3BlblwiXSlcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbWl0Q2hhbmdlU291cmNlLm5leHQoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBpZighdGhpcy5zZWxlY3RlZFVzZXJzW21lc3NhZ2UuX2lkXSlcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0wOyBpPCB0aGlzLmxpc3RVc2Vycy5sZW5ndGg7IGkrKylcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmxpc3RVc2Vyc1tpXVtcIl9pZFwiXSA9PSBtZXNzYWdlLl9pZClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdFVzZXJzW2ldW1wiYmFkZ2VcIl0gKys7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2luZ2xldG9uLmNoYXRCYWRnZSArKztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbWl0Q2hhbmdlVXNlcnMubmV4dCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gXG4gICAgICAgICAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZFVzZXJzW21lc3NhZ2UuX2lkXVtcIm1lc3NhZ2VzXCJdLnB1c2gobWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnNlbGVjdGVkVXNlcnNbbWVzc2FnZS5faWRdW1wiY2hhdE9wZW5cIl0pXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbW1pdEZvY3VzKHtyb29tX2lkOiB0aGlzLnNlbGVjdGVkVXNlcnNbbWVzc2FnZS5faWRdW1wicm9vbV9pZFwiXSwgdXBkYXRlQWxsOiBmYWxzZSwgc2VuZGVySWQ6IG1lc3NhZ2UuX2lkfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZVtcInRvVXNlclJlYWRcIl0gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdENoYW5nZVNvdXJjZS5uZXh0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zaW5nbGV0b24uY2hhdEJhZGdlICsrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiaW5jcmVtZW50aW5nIHRoZSBiYWRnZS4uLlwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkVXNlcnNbbWVzc2FnZS5faWRdW1wiYmFkZ2VcIl0gPSB0aGlzLnNlbGVjdGVkVXNlcnNbbWVzc2FnZS5faWRdW1wiYmFkZ2VcIl0gKyAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwidGhlIGJhZGdlIG5vdyBpczogXCIrdGhpcy5zZWxlY3RlZFVzZXJzW21lc3NhZ2UuX2lkXVtcImJhZGdlXCJdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVtaXRDaGFuZ2VVc2Vycy5uZXh0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9KVxuICAgIH1cblxuICAgIC8vIGV2ZW50byByZXNwb25zw6F2ZWwgcG9yIGVtaXRpciBvIGZvY3VzLCBvdSBzZWphLCBjb25maXJtYXIgbGVpdHVyYSBkZSBkYXMgbWVuc2FnZW5zXG4gICAgZW1taXRGb2N1cyhvYmopXG4gICAge1xuICAgICAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4ge1xuICAgICAgICAgICAgaWYodGhpcy5zZWxlY3RlZFVzZXJzW29ialtcInNlbmRlcklkXCJdXVtcIm1lc3NhZ2VzXCJdKVxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHRoaXMuc29ja2V0LmVtaXQoJ2ZvY3VzJywgb2JqW1wicm9vbV9pZFwiXSk7XG4gICAgICAgICAgICAgICAgaWYob2JqW1widXBkYXRlQWxsXCJdKVxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZFVzZXJzW29ialtcInNlbmRlcklkXCJdXVtcIm1lc3NhZ2VzXCJdLmZvckVhY2goZWxlbWVudCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZihlbGVtZW50Ll9pZCA9PSBvYmpbXCJzZW5kZXJJZFwiXSlcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50W1widG9Vc2VyUmVhZFwiXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLnNpbmdsZXRvbi5jaGF0QmFkZ2UgPSB0aGlzLnNpbmdsZXRvbi5jaGF0QmFkZ2UgLSAgdGhpcy5zZWxlY3RlZFVzZXJzW29ialtcInNlbmRlcklkXCJdXVtcImJhZGdlXCJdO1xuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRVc2Vyc1tvYmpbXCJzZW5kZXJJZFwiXV1bXCJiYWRnZVwiXSA9IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgfVxuXG4gICAgLy8gRXZlbnRvIHJlc3BvbnPDoXZlbCBlbWl0aXIgcGFyYSBvIHNlcnZpZG9yIGEgc2VsZcOnw6NvIGRlIHVtIHVzdcOhcmlvXG4gICAgZW1taXRTZWxlY3QoX2lkKXtcbiAgICAgICAgY29uc29sZS5sb2coXCJ1c2VyIGlkOlwiK19pZCk7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSk9PntcbiAgICAgICAgICAgIHRoaXMuc29ja2V0LmVtaXQoJ3NlbGVjdFVzZXInLHtfaWQ6IHRoaXMuc2luZ2xldG9uLnVzZXJbXCJfaWRcIl0sIHRvVXNlcjogX2lkfSwgKHJvb20pPT57XG4gICAgICAgICAgICAgICAgdGhpcy5uZ1pvbmUucnVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZFVzZXJzW19pZF1bXCJtZXNzYWdlc1wiXSA9IHJvb21bXCJtZXNzYWdlc1wiXSB8fCBbXTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZFVzZXJzW19pZF1bXCJyb29tX2lkXCJdID0gcm9vbVtcIl9pZFwiXTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbW1pdEZvY3VzKHtyb29tX2lkOnJvb21bXCJfaWRcIl0sIHNlbmRlcklkOiBfaWQsIHVwZGF0ZUFsbDogdHJ1ZX0pO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KVxuICAgICAgICB9KVxuICAgIH1cblxuICAgIC8vIEV2ZW50byByZXNwb25zw6F2ZWwgcG9yIHNlIGRlc2NvbmVjdGFyIGRvIHNlcnZpZG9yXG4gICAgZGlzY29uZWN0KCl7XG4gICAgICAgIHRoaXMuaW50aWFsaXplZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLnNvY2tldC5kaXNjb25lY3QoKTtcbiAgICB9XG5cbiAgICAvLyBFdmVudG8gcmVzcG9uc8OhdmVsIHBvciBlbWl0aXIgdW1hIG1lbnNhZ2VtIHBhcmEgbyBzZXJ2aWRvclxuICAgIHNlbmRNZXNzYWdlKGFycilcbiAgICB7XG4gICAgICB0aGlzLnNvY2tldC5lbWl0KCdzZW5kTWVzc2FnZScsICB7IHJvb21faWQ6IGFyclsyXSwgbmFtZTogdGhpcy5zaW5nbGV0b24udXNlcltcIm5hbWVcIl0sIF9pZDogdGhpcy5zaW5nbGV0b24udXNlcltcIl9pZFwiXSwgbWVzc2FnZTogYXJyWzBdLCB0b1VzZXI6IGFyclsxXSwgZGF0ZTogRGF0ZS5ub3coKSwgdG9Vc2VyUmVhZDogZmFsc2V9KTtcbiAgICB9XG59Il19