"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var Subject_1 = require("rxjs/Subject");
var SocketIO = require("nativescript-socket.io");
var singleton_service_1 = require("../singleton-service/singleton.service");
var common_functions_service_1 = require("../common-functions-service/common-functions.service");
var SocketService = /** @class */ (function () {
    function SocketService(ngZone, singleton, cfs) {
        this.ngZone = ngZone;
        this.singleton = singleton;
        this.cfs = cfs;
        this.userBadge = 0;
        this.selectedUsers = {};
        this.listUsers = [];
        this.formTools = new core_1.EventEmitter();
        this.emitChangeSource = new Subject_1.Subject();
        this.changeEmitted$ = this.emitChangeSource.asObservable();
        this.emitChangeUsers = new Subject_1.Subject();
        this.changeUsersEmitted$ = this.emitChangeUsers.asObservable();
        this.intialized = false;
    }
    SocketService.prototype.initSocket = function () {
        var _this = this;
        // marcamos a variável this.intialized para true, para que o socket não seja iniciado mais de uma vez
        this.intialized = true;
        // pedimos conexão do socket para o servidor
        // OBS: passamos o token do usuário para que o token seja validado na hora da conexão ao socket
        this.socket = SocketIO.connect(this.singleton.serverUrl, { query: { 'Authorization': localStorage.getItem('token') } });
        // Evento responsável por ouvir logins de usuários
        this.socket.on('userlogin', function (userLogin) {
            var _this = this;
            console.log("Login de usuário com o id: " + userLogin._id);
            this.ngZone.run(function () {
                // verifico se o id do usuário que efetuou login é igual ao nosso, para que não sejamos notificados do nosso proprio  login em outro dispositivo
                if (userLogin._id != _this.singleton.user["_id"]) {
                    // se for diferente, preciso achar o usuário que efetuou o login e tornar o status dele para true(online)
                    _this.listUsers.map(function (user) {
                        if (user._id == userLogin._id) {
                            if (!user.status) {
                                user.status = true;
                            }
                        }
                    });
                    // ordenamos nossa lista de usuários pelo status
                }
                _this.listUsers = _this.cfs.orderByProperty(_this.listUsers, 'status');
                _this.emitChangeUsers.next();
            });
        }.bind(this));
        // lista dos usuários cadastrados no sistema
        this.socket.on('listUsers', function (listUsers) {
            _this.ngZone.run(function () {
                _this.listUsers = listUsers.all;
                _this.listUsers.map(function (user) {
                    // pegamos o número da badge do usuário e passamos para o objeto user
                    user["badge"] = listUsers["userBadge"][user._id] || 0;
                    _this.singleton.chatBadge += user["badge"];
                    // verificamos se o id do usuário está na lista de usuários online, se estiver, tornamos o status dele para true
                    if (listUsers.available.indexOf(user._id) > -1) {
                        user.status = true;
                    }
                });
                // ordenamos nossa lista de usuários pelo status
                _this.listUsers = _this.cfs.orderByProperty(_this.listUsers, 'status');
                // emitimos um sinal para nosso chatComponent, para dizer que temos uma lista de usuários disponivel para ele
                _this.emitChangeUsers.next();
            });
        });
        // Evento responsável por ouvir leituras dos usuários a mensagens que você enviou
        this.socket.on('receiverRead', function (userId) {
            console.log("recebeu leitura do usuário: " + userId);
            _this.ngZone.run(function () {
                if (_this.selectedUsers[userId]) {
                    var currentDate = Date.now();
                    _this.selectedUsers[userId].messages.forEach(function (element) {
                        if (element.toUser == userId && !element["toUserRead"]) {
                            element["toUserRead"] = true;
                            element["toUserReadDate"] = currentDate;
                            _this.emitChangeSource.next();
                        }
                    });
                }
            });
        });
        // Evento responsável por ouvir logout de usuários
        this.socket.on('userLogout', function (userId) {
            _this.ngZone.run(function () {
                _this.listUsers.map(function (user) {
                    if (user._id == userId) {
                        user.status = false;
                    }
                });
                _this.listUsers = _this.cfs.orderByProperty(_this.listUsers, 'status');
                _this.emitChangeUsers.next();
            });
        });
        // Evento responsável por ouvir o novas mensagens
        this.socket.on('newMessage', function (message) {
            console.log("new message...");
            _this.ngZone.run(function () {
                if (message._id == _this.singleton.user["_id"] && _this.selectedUsers[message.toUser]) {
                    _this.selectedUsers[message.toUser]["messages"].push(message);
                    if (_this.selectedUsers[message.toUser]["chatOpen"]) {
                        _this.emitChangeSource.next();
                    }
                }
                else {
                    if (!_this.selectedUsers[message._id]) {
                        for (var i = 0; i < _this.listUsers.length; i++) {
                            if (_this.listUsers[i]["_id"] == message._id) {
                                _this.listUsers[i]["badge"]++;
                                _this.singleton.chatBadge++;
                                _this.emitChangeUsers.next();
                                break;
                            }
                        }
                    }
                    else {
                        _this.selectedUsers[message._id]["messages"].push(message);
                        if (_this.selectedUsers[message._id]["chatOpen"]) {
                            _this.emmitFocus({ room_id: _this.selectedUsers[message._id]["room_id"], updateAll: false, senderId: message._id });
                            message["toUserRead"] = true;
                            _this.emitChangeSource.next();
                        }
                        else {
                            _this.singleton.chatBadge++;
                            console.log("incrementing the badge...");
                            _this.selectedUsers[message._id]["badge"] = _this.selectedUsers[message._id]["badge"] + 1;
                            console.log("the badge now is: " + _this.selectedUsers[message._id]["badge"]);
                            _this.emitChangeUsers.next();
                        }
                    }
                }
            });
        });
    };
    // evento responsável por emitir o focus, ou seja, confirmar leitura de das mensagens
    SocketService.prototype.emmitFocus = function (obj) {
        var _this = this;
        this.ngZone.run(function () {
            if (_this.selectedUsers[obj["senderId"]]["messages"]) {
                _this.socket.emit('focus', obj["room_id"]);
                if (obj["updateAll"]) {
                    _this.selectedUsers[obj["senderId"]]["messages"].forEach(function (element) {
                        if (element._id == obj["senderId"]) {
                            element["toUserRead"] = true;
                        }
                    });
                }
                _this.singleton.chatBadge = _this.singleton.chatBadge - _this.selectedUsers[obj["senderId"]]["badge"];
                _this.selectedUsers[obj["senderId"]]["badge"] = 0;
            }
        });
    };
    // Evento responsável emitir para o servidor a seleção de um usuário
    SocketService.prototype.emmitSelect = function (_id) {
        var _this = this;
        console.log("user id:" + _id);
        return new Promise(function (resolve) {
            _this.socket.emit('selectUser', { _id: _this.singleton.user["_id"], toUser: _id }, function (room) {
                _this.ngZone.run(function () {
                    _this.selectedUsers[_id]["messages"] = room["messages"] || [];
                    _this.selectedUsers[_id]["room_id"] = room["_id"];
                    _this.emmitFocus({ room_id: room["_id"], senderId: _id, updateAll: true });
                    return resolve();
                });
            });
        });
    };
    // Evento responsável por se desconectar do servidor
    SocketService.prototype.disconect = function () {
        this.intialized = false;
        this.socket.disconect();
    };
    // Evento responsável por emitir uma mensagem para o servidor
    SocketService.prototype.sendMessage = function (arr) {
        this.socket.emit('sendMessage', { room_id: arr[2], name: this.singleton.user["name"], _id: this.singleton.user["_id"], message: arr[0], toUser: arr[1], date: Date.now(), toUserRead: false });
    };
    SocketService = __decorate([
        core_1.Injectable(),
        __metadata("design:paramtypes", [core_1.NgZone, singleton_service_1.SingletonService, common_functions_service_1.CommonFunctionsService])
    ], SocketService);
    return SocketService;
}());
exports.SocketService = SocketService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ja2V0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzb2NrZXQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLHNDQUFpRTtBQUNqRSx3Q0FBdUM7QUFDdkMsaURBQW1EO0FBQ25ELDRFQUEwRTtBQUMxRSxpR0FBOEY7QUFFOUY7SUFZSSx1QkFBb0IsTUFBYSxFQUFTLFNBQTBCLEVBQVMsR0FBMkI7UUFBcEYsV0FBTSxHQUFOLE1BQU0sQ0FBTztRQUFTLGNBQVMsR0FBVCxTQUFTLENBQWlCO1FBQVMsUUFBRyxHQUFILEdBQUcsQ0FBd0I7UUFWeEcsY0FBUyxHQUFHLENBQUMsQ0FBQztRQUNkLGtCQUFhLEdBQUcsRUFBRSxDQUFDO1FBQ25CLGNBQVMsR0FBRyxFQUFFLENBQUM7UUFDZixjQUFTLEdBQXNCLElBQUksbUJBQVksRUFBRSxDQUFDO1FBQzFDLHFCQUFnQixHQUFHLElBQUksaUJBQU8sRUFBTyxDQUFDO1FBQzlDLG1CQUFjLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFlBQVksRUFBRSxDQUFDO1FBQzlDLG9CQUFlLEdBQUcsSUFBSSxpQkFBTyxFQUFPLENBQUM7UUFDN0Msd0JBQW1CLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUMxRCxlQUFVLEdBQUcsS0FBSyxDQUFDO0lBRXdGLENBQUM7SUFDckcsa0NBQVUsR0FBakI7UUFBQSxpQkE0SUM7UUEzSUcscUdBQXFHO1FBQ3JHLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBRXZCLDRDQUE0QztRQUM1QywrRkFBK0Y7UUFDL0YsSUFBSSxDQUFDLE1BQU0sR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLEVBQUMsS0FBSyxFQUFFLEVBQUMsZUFBZSxFQUFFLFlBQVksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBQyxDQUFDLENBQUM7UUFF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QUFXLEdBQVgsVUFBWSxHQUFHO1FBRWIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFHLEVBQUUsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUMsQ0FBQyxDQUFDO0lBQ2pNLENBQUM7SUExTVEsYUFBYTtRQUR6QixpQkFBVSxFQUFFO3lDQWFrQixhQUFNLEVBQW1CLG9DQUFnQixFQUFjLGlEQUFzQjtPQVovRixhQUFhLENBMk16QjtJQUFELG9CQUFDO0NBQUEsQUEzTUQsSUEyTUM7QUEzTVksc0NBQWEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcy9PYnNlcnZhYmxlJztcbmltcG9ydCB7IEluamVjdGFibGUsIEV2ZW50RW1pdHRlciwgTmdab25lIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcy9TdWJqZWN0JztcbmltcG9ydCAqIGFzIFNvY2tldElPIGZyb20gXCJuYXRpdmVzY3JpcHQtc29ja2V0LmlvXCI7XG5pbXBvcnQgeyBTaW5nbGV0b25TZXJ2aWNlIH0gZnJvbSAnLi4vc2luZ2xldG9uLXNlcnZpY2Uvc2luZ2xldG9uLnNlcnZpY2UnO1xuaW1wb3J0IHsgQ29tbW9uRnVuY3Rpb25zU2VydmljZSB9IGZyb20gJy4uL2NvbW1vbi1mdW5jdGlvbnMtc2VydmljZS9jb21tb24tZnVuY3Rpb25zLnNlcnZpY2UnO1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFNvY2tldFNlcnZpY2Uge1xuICAgIHNvY2tldDogYW55O1xuICAgIHVzZXJCYWRnZSA9IDA7XG4gICAgc2VsZWN0ZWRVc2VycyA9IHt9O1xuICAgIGxpc3RVc2VycyA9IFtdO1xuICAgIGZvcm1Ub29sczogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgcHJpdmF0ZSBlbWl0Q2hhbmdlU291cmNlID0gbmV3IFN1YmplY3Q8YW55PigpO1xuICAgIGNoYW5nZUVtaXR0ZWQkID0gdGhpcy5lbWl0Q2hhbmdlU291cmNlLmFzT2JzZXJ2YWJsZSgpO1xuICAgIHByaXZhdGUgZW1pdENoYW5nZVVzZXJzID0gbmV3IFN1YmplY3Q8YW55PigpO1xuICAgIGNoYW5nZVVzZXJzRW1pdHRlZCQgPSB0aGlzLmVtaXRDaGFuZ2VVc2Vycy5hc09ic2VydmFibGUoKTtcbiAgICBpbnRpYWxpemVkID0gZmFsc2U7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIG5nWm9uZTpOZ1pvbmUsIHB1YmxpYyBzaW5nbGV0b246U2luZ2xldG9uU2VydmljZSwgcHVibGljIGNmczogQ29tbW9uRnVuY3Rpb25zU2VydmljZSkge31cbiAgICBwdWJsaWMgaW5pdFNvY2tldCgpe1xuICAgICAgICAvLyBtYXJjYW1vcyBhIHZhcmnDoXZlbCB0aGlzLmludGlhbGl6ZWQgcGFyYSB0cnVlLCBwYXJhIHF1ZSBvIHNvY2tldCBuw6NvIHNlamEgaW5pY2lhZG8gbWFpcyBkZSB1bWEgdmV6XG4gICAgICAgIHRoaXMuaW50aWFsaXplZCA9IHRydWU7XG5cbiAgICAgICAgLy8gcGVkaW1vcyBjb25leMOjbyBkbyBzb2NrZXQgcGFyYSBvIHNlcnZpZG9yXG4gICAgICAgIC8vIE9CUzogcGFzc2Ftb3MgbyB0b2tlbiBkbyB1c3XDoXJpbyBwYXJhIHF1ZSBvIHRva2VuIHNlamEgdmFsaWRhZG8gbmEgaG9yYSBkYSBjb25leMOjbyBhbyBzb2NrZXRcbiAgICAgICAgdGhpcy5zb2NrZXQgPSBTb2NrZXRJTy5jb25uZWN0KHRoaXMuc2luZ2xldG9uLnNlcnZlclVybCwge3F1ZXJ5OiB7J0F1dGhvcml6YXRpb24nOiBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgndG9rZW4nKSB9fSk7XG4gICAgICAgIFxuICAgICAgICAvLyBFdmVudG8gcmVzcG9uc8OhdmVsIHBvciBvdXZpciBsb2dpbnMgZGUgdXN1w6FyaW9zXG4gICAgICAgIHRoaXMuc29ja2V0Lm9uKCd1c2VybG9naW4nLCBmdW5jdGlvbiAodXNlckxvZ2luKSB7XG5cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiTG9naW4gZGUgdXN1w6FyaW8gY29tIG8gaWQ6IFwiK3VzZXJMb2dpbi5faWQpO1xuICAgICAgICAgICAgdGhpcy5uZ1pvbmUucnVuKCgpID0+IHtcbiAgICAgICAgICAgIC8vIHZlcmlmaWNvIHNlIG8gaWQgZG8gdXN1w6FyaW8gcXVlIGVmZXR1b3UgbG9naW4gw6kgaWd1YWwgYW8gbm9zc28sIHBhcmEgcXVlIG7Do28gc2VqYW1vcyBub3RpZmljYWRvcyBkbyBub3NzbyBwcm9wcmlvICBsb2dpbiBlbSBvdXRybyBkaXNwb3NpdGl2b1xuICAgICAgICAgICAgICAgIGlmKHVzZXJMb2dpbi5faWQgIT0gdGhpcy5zaW5nbGV0b24udXNlcltcIl9pZFwiXSlcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIC8vIHNlIGZvciBkaWZlcmVudGUsIHByZWNpc28gYWNoYXIgbyB1c3XDoXJpbyBxdWUgZWZldHVvdSBvIGxvZ2luIGUgdG9ybmFyIG8gc3RhdHVzIGRlbGUgcGFyYSB0cnVlKG9ubGluZSlcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdFVzZXJzLm1hcCh1c2VyPT57XG4gICAgICAgICAgICAgICAgICAgICAgICBpZih1c2VyLl9pZCA9PSB1c2VyTG9naW4uX2lkKVxuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCF1c2VyLnN0YXR1cylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXIuc3RhdHVzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLy8gb3JkZW5hbW9zIG5vc3NhIGxpc3RhIGRlIHVzdcOhcmlvcyBwZWxvIHN0YXR1c1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLmxpc3RVc2VycyA9IHRoaXMuY2ZzLm9yZGVyQnlQcm9wZXJ0eSh0aGlzLmxpc3RVc2VycywgJ3N0YXR1cycpO1xuICAgICAgICAgICAgICAgIHRoaXMuZW1pdENoYW5nZVVzZXJzLm5leHQoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9LmJpbmQodGhpcykpO1xuXG4gICAgICAgIC8vIGxpc3RhIGRvcyB1c3XDoXJpb3MgY2FkYXN0cmFkb3Mgbm8gc2lzdGVtYVxuICAgICAgICB0aGlzLnNvY2tldC5vbignbGlzdFVzZXJzJywgKGxpc3RVc2Vycyk9PntcbiAgICAgICAgICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5saXN0VXNlcnMgPSBsaXN0VXNlcnMuYWxsO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHRoaXMubGlzdFVzZXJzLm1hcCh1c2VyPT57XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gcGVnYW1vcyBvIG7Dum1lcm8gZGEgYmFkZ2UgZG8gdXN1w6FyaW8gZSBwYXNzYW1vcyBwYXJhIG8gb2JqZXRvIHVzZXJcbiAgICAgICAgICAgICAgICAgICAgdXNlcltcImJhZGdlXCJdID0gbGlzdFVzZXJzW1widXNlckJhZGdlXCJdW3VzZXIuX2lkXSB8fCAwO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNpbmdsZXRvbi5jaGF0QmFkZ2UgKz0gdXNlcltcImJhZGdlXCJdO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIHZlcmlmaWNhbW9zIHNlIG8gaWQgZG8gdXN1w6FyaW8gZXN0w6EgbmEgbGlzdGEgZGUgdXN1w6FyaW9zIG9ubGluZSwgc2UgZXN0aXZlciwgdG9ybmFtb3MgbyBzdGF0dXMgZGVsZSBwYXJhIHRydWVcbiAgICAgICAgICAgICAgICAgICAgaWYobGlzdFVzZXJzLmF2YWlsYWJsZS5pbmRleE9mKHVzZXIuX2lkKSA+IC0xKVxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VyLnN0YXR1cyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC8vIG9yZGVuYW1vcyBub3NzYSBsaXN0YSBkZSB1c3XDoXJpb3MgcGVsbyBzdGF0dXNcbiAgICAgICAgICAgICAgICB0aGlzLmxpc3RVc2VycyA9IHRoaXMuY2ZzLm9yZGVyQnlQcm9wZXJ0eSh0aGlzLmxpc3RVc2VycywgJ3N0YXR1cycpXG5cbiAgICAgICAgICAgICAgICAvLyBlbWl0aW1vcyB1bSBzaW5hbCBwYXJhIG5vc3NvIGNoYXRDb21wb25lbnQsIHBhcmEgZGl6ZXIgcXVlIHRlbW9zIHVtYSBsaXN0YSBkZSB1c3XDoXJpb3MgZGlzcG9uaXZlbCBwYXJhIGVsZVxuICAgICAgICAgICAgICAgIHRoaXMuZW1pdENoYW5nZVVzZXJzLm5leHQoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuXG4gICAgICAgIC8vIEV2ZW50byByZXNwb25zw6F2ZWwgcG9yIG91dmlyIGxlaXR1cmFzIGRvcyB1c3XDoXJpb3MgYSBtZW5zYWdlbnMgcXVlIHZvY8OqIGVudmlvdVxuICAgICAgICB0aGlzLnNvY2tldC5vbigncmVjZWl2ZXJSZWFkJywgKHVzZXJJZCk9PntcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicmVjZWJldSBsZWl0dXJhIGRvIHVzdcOhcmlvOiBcIit1c2VySWQpO1xuICAgICAgICAgICAgdGhpcy5uZ1pvbmUucnVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICBpZih0aGlzLnNlbGVjdGVkVXNlcnNbdXNlcklkXSlcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50RGF0ZSA9IERhdGUubm93KCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRVc2Vyc1t1c2VySWRdLm1lc3NhZ2VzLmZvckVhY2goZWxlbWVudCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZihlbGVtZW50LnRvVXNlciA9PSB1c2VySWQgJiYgIWVsZW1lbnRbXCJ0b1VzZXJSZWFkXCJdKVxuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnRbXCJ0b1VzZXJSZWFkXCJdID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50W1widG9Vc2VyUmVhZERhdGVcIl0gPSBjdXJyZW50RGF0ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVtaXRDaGFuZ2VTb3VyY2UubmV4dCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9KVxuXG4gICAgICAgIC8vIEV2ZW50byByZXNwb25zw6F2ZWwgcG9yIG91dmlyIGxvZ291dCBkZSB1c3XDoXJpb3NcbiAgICAgICAgdGhpcy5zb2NrZXQub24oJ3VzZXJMb2dvdXQnLCAodXNlcklkKT0+e1xuICAgICAgICAgICAgdGhpcy5uZ1pvbmUucnVuKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMubGlzdFVzZXJzLm1hcCh1c2VyPT57XG4gICAgICAgICAgICAgICAgaWYodXNlci5faWQgPT0gdXNlcklkKVxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdXNlci5zdGF0dXMgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB0aGlzLmxpc3RVc2VycyA9IHRoaXMuY2ZzLm9yZGVyQnlQcm9wZXJ0eSh0aGlzLmxpc3RVc2VycywgJ3N0YXR1cycpO1xuICAgICAgICAgICAgICAgIHRoaXMuZW1pdENoYW5nZVVzZXJzLm5leHQoKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG5cbiAgICAgICAgLy8gRXZlbnRvIHJlc3BvbnPDoXZlbCBwb3Igb3V2aXIgbyBub3ZhcyBtZW5zYWdlbnNcbiAgICAgICAgdGhpcy5zb2NrZXQub24oJ25ld01lc3NhZ2UnLCAobWVzc2FnZSk9PntcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwibmV3IG1lc3NhZ2UuLi5cIik7XG4gICAgICAgICAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmKG1lc3NhZ2UuX2lkID09IHRoaXMuc2luZ2xldG9uLnVzZXJbXCJfaWRcIl0gJiYgdGhpcy5zZWxlY3RlZFVzZXJzW21lc3NhZ2UudG9Vc2VyXSlcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRVc2Vyc1ttZXNzYWdlLnRvVXNlcl1bXCJtZXNzYWdlc1wiXS5wdXNoKG1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnNlbGVjdGVkVXNlcnNbbWVzc2FnZS50b1VzZXJdW1wiY2hhdE9wZW5cIl0pXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdENoYW5nZVNvdXJjZS5uZXh0KCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgaWYoIXRoaXMuc2VsZWN0ZWRVc2Vyc1ttZXNzYWdlLl9pZF0pXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9MDsgaTwgdGhpcy5saXN0VXNlcnMubGVuZ3RoOyBpKyspXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5saXN0VXNlcnNbaV1bXCJfaWRcIl0gPT0gbWVzc2FnZS5faWQpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxpc3RVc2Vyc1tpXVtcImJhZGdlXCJdICsrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNpbmdsZXRvbi5jaGF0QmFkZ2UgKys7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdENoYW5nZVVzZXJzLm5leHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IFxuICAgICAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRVc2Vyc1ttZXNzYWdlLl9pZF1bXCJtZXNzYWdlc1wiXS5wdXNoKG1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5zZWxlY3RlZFVzZXJzW21lc3NhZ2UuX2lkXVtcImNoYXRPcGVuXCJdKVxuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW1taXRGb2N1cyh7cm9vbV9pZDogdGhpcy5zZWxlY3RlZFVzZXJzW21lc3NhZ2UuX2lkXVtcInJvb21faWRcIl0sIHVwZGF0ZUFsbDogZmFsc2UsIHNlbmRlcklkOiBtZXNzYWdlLl9pZH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2VbXCJ0b1VzZXJSZWFkXCJdID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVtaXRDaGFuZ2VTb3VyY2UubmV4dCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2luZ2xldG9uLmNoYXRCYWRnZSArKztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImluY3JlbWVudGluZyB0aGUgYmFkZ2UuLi5cIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZFVzZXJzW21lc3NhZ2UuX2lkXVtcImJhZGdlXCJdID0gdGhpcy5zZWxlY3RlZFVzZXJzW21lc3NhZ2UuX2lkXVtcImJhZGdlXCJdICsgMTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInRoZSBiYWRnZSBub3cgaXM6IFwiK3RoaXMuc2VsZWN0ZWRVc2Vyc1ttZXNzYWdlLl9pZF1bXCJiYWRnZVwiXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbWl0Q2hhbmdlVXNlcnMubmV4dCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICAvLyBldmVudG8gcmVzcG9uc8OhdmVsIHBvciBlbWl0aXIgbyBmb2N1cywgb3Ugc2VqYSwgY29uZmlybWFyIGxlaXR1cmEgZGUgZGFzIG1lbnNhZ2Vuc1xuICAgIGVtbWl0Rm9jdXMob2JqKVxuICAgIHtcbiAgICAgICAgdGhpcy5uZ1pvbmUucnVuKCgpID0+IHtcbiAgICAgICAgICAgIGlmKHRoaXMuc2VsZWN0ZWRVc2Vyc1tvYmpbXCJzZW5kZXJJZFwiXV1bXCJtZXNzYWdlc1wiXSlcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNvY2tldC5lbWl0KCdmb2N1cycsIG9ialtcInJvb21faWRcIl0pO1xuICAgICAgICAgICAgICAgIGlmKG9ialtcInVwZGF0ZUFsbFwiXSlcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRVc2Vyc1tvYmpbXCJzZW5kZXJJZFwiXV1bXCJtZXNzYWdlc1wiXS5mb3JFYWNoKGVsZW1lbnQgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYoZWxlbWVudC5faWQgPT0gb2JqW1wic2VuZGVySWRcIl0pXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudFtcInRvVXNlclJlYWRcIl0gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5zaW5nbGV0b24uY2hhdEJhZGdlID0gdGhpcy5zaW5nbGV0b24uY2hhdEJhZGdlIC0gIHRoaXMuc2VsZWN0ZWRVc2Vyc1tvYmpbXCJzZW5kZXJJZFwiXV1bXCJiYWRnZVwiXTtcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkVXNlcnNbb2JqW1wic2VuZGVySWRcIl1dW1wiYmFkZ2VcIl0gPSAwO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgIH1cblxuICAgIC8vIEV2ZW50byByZXNwb25zw6F2ZWwgZW1pdGlyIHBhcmEgbyBzZXJ2aWRvciBhIHNlbGXDp8OjbyBkZSB1bSB1c3XDoXJpb1xuICAgIGVtbWl0U2VsZWN0KF9pZCl7XG4gICAgICAgIGNvbnNvbGUubG9nKFwidXNlciBpZDpcIitfaWQpO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpPT57XG4gICAgICAgICAgICB0aGlzLnNvY2tldC5lbWl0KCdzZWxlY3RVc2VyJyx7X2lkOiB0aGlzLnNpbmdsZXRvbi51c2VyW1wiX2lkXCJdLCB0b1VzZXI6IF9pZH0sIChyb29tKT0+e1xuICAgICAgICAgICAgICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRVc2Vyc1tfaWRdW1wibWVzc2FnZXNcIl0gPSByb29tW1wibWVzc2FnZXNcIl0gfHwgW107XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRVc2Vyc1tfaWRdW1wicm9vbV9pZFwiXSA9IHJvb21bXCJfaWRcIl07XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZW1taXRGb2N1cyh7cm9vbV9pZDpyb29tW1wiX2lkXCJdLCBzZW5kZXJJZDogX2lkLCB1cGRhdGVBbGw6IHRydWV9KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICAvLyBFdmVudG8gcmVzcG9uc8OhdmVsIHBvciBzZSBkZXNjb25lY3RhciBkbyBzZXJ2aWRvclxuICAgIGRpc2NvbmVjdCgpe1xuICAgICAgICB0aGlzLmludGlhbGl6ZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5zb2NrZXQuZGlzY29uZWN0KCk7XG4gICAgfVxuXG4gICAgLy8gRXZlbnRvIHJlc3BvbnPDoXZlbCBwb3IgZW1pdGlyIHVtYSBtZW5zYWdlbSBwYXJhIG8gc2Vydmlkb3JcbiAgICBzZW5kTWVzc2FnZShhcnIpXG4gICAge1xuICAgICAgdGhpcy5zb2NrZXQuZW1pdCgnc2VuZE1lc3NhZ2UnLCAgeyByb29tX2lkOiBhcnJbMl0sIG5hbWU6IHRoaXMuc2luZ2xldG9uLnVzZXJbXCJuYW1lXCJdLCBfaWQ6IHRoaXMuc2luZ2xldG9uLnVzZXJbXCJfaWRcIl0sIG1lc3NhZ2U6IGFyclswXSwgdG9Vc2VyOiBhcnJbMV0sIGRhdGU6IERhdGUubm93KCksIHRvVXNlclJlYWQ6IGZhbHNlfSk7XG4gICAgfVxufSJdfQ==